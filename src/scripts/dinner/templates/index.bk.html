<!DOCTYPE html>
<html>
<head>
  <title>Control de Robot</title>
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
  <h2>Presiona W para rueda izquierda, E para la derecha</h2>
  <label>Velocidad Izq: <input type="number" min="0" max="255" id="speedA" value="80"></label>
  <label>Velocidad Der: <input type="number" min="0" max="255" id="speedB" value="80"></label><br>
  
  <div>
    <label><input type="checkbox" id="boost1"> Boost 1 (Tecla 1)</label>
    <input type="number" id="boost1Value" value="5" min="0" max="255">
  </div>
  <div>
    <label><input type="checkbox" id="boost2"> Boost 2 (Tecla 2)</label>
    <input type="number" id="boost2Value" value="10" min="0" max="255">
  </div>
  <label><input type="checkbox" id="reversa_motor_1" onclick="setActuatorsData('s', this.checked ? 'on' : 'off')">Reversa motor 1</label>
  <br>
  <label><input type="checkbox" id="reversa_motor_2" onclick="setActuatorsData('d', this.checked ? 'on' : 'off')">Reversa motor 2</label>
  <br>
  <label><input type="checkbox" id="reversa_ambos" onclick="setActuatorsData('a', this.checked ? 'on' : 'off')">Reversa ambos</label>
  <br>
  <pre id="console" style="background:#111; color:#0f0; padding:10px; height:200px; overflow:auto;"></pre>
  
  <script>
    const socket = io("http://{{ ip_local }}:5000");

    const keysPressed = new Set();

    function setActuatorsData(servo, angle) {
      socket.emit('actuators', {
        key: servo,
        value: angle,
      });
    }

    function actualizarMovimiento() {
      const acciones = Array.from(keysPressed);
      let speedA = parseInt(document.getElementById('speedA').value) || 80;
      let speedB = parseInt(document.getElementById('speedB').value) || 80;
      
      // Aplicar boosts si están activados
      if (document.getElementById('boost1').checked) {
        const boost1 = parseInt(document.getElementById('boost1Value').value) || 5;
        speedA += boost1;
        speedB += boost1;
      }
      
      if (document.getElementById('boost2').checked) {
        const boost2 = parseInt(document.getElementById('boost2Value').value) || 10;
        speedA += boost2;
        speedB += boost2;
      }
      
      // Asegurar que no excedamos el máximo de 255
      speedA = Math.min(255, speedA);
      speedB = Math.min(255, speedB);
      
      const velA = acciones.includes('W') ? speedA : 0;
      const velB = acciones.includes('E') ? speedB : 0;


      socket.emit('movimiento', {
        keys: acciones,
        speedA: speedA,
        speedB: speedB,
      });
    }

    document.addEventListener('keydown', (e) => {
      console.log(e.key);
      const key = e.key.toUpperCase();
      if (['W', 'E'].includes(key)) keysPressed.add(key);
      
      // Manejar teclas numéricas para los boosts
      if (e.key === '1') {
        const checkbox = document.getElementById('boost1');
        checkbox.checked = !checkbox.checked;
      }
      if (e.key === '2') {
        const checkbox = document.getElementById('boost2');
        checkbox.checked = !checkbox.checked;
      }
      if (e.key === 's') {
        const checkbox = document.getElementById('reversa_motor_1');
        checkbox.checked = !checkbox.checked;
        setActuatorsData('s', checkbox.checked ? 'on' : 'off');
      }
      if (e.key === 'd') {
        const checkbox = document.getElementById('reversa_motor_2');
        checkbox.checked = !checkbox.checked;
        setActuatorsData('d', checkbox.checked ? 'on' : 'off');
      }
      if (e.key === 'a') {
        const checkbox = document.getElementById('reversa_ambos');
        checkbox.checked = !checkbox.checked;
        setActuatorsData('a', checkbox.checked ? 'on' : 'off');
      }

    });

    document.addEventListener('keyup', (e) => {
      const key = e.key.toUpperCase();
      keysPressed.delete(key);
    });

    socket.on('arduino_output', (data) => {
      const consola = document.getElementById('console');
      consola.textContent += data.linea + '\n';
      consola.scrollTop = consola.scrollHeight;
    });

    setInterval(actualizarMovimiento, 100);
  </script>
</body>
